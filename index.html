<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width">
		<title>Voter Registration in Oklahoma</title>

		<!--put your external stylesheet links here-->
		<link href="https://fonts.googleapis.com/css?family=Open+Sans+Condensed:300,700" rel="stylesheet">
		<link rel="stylesheet" href="css/style.css">
		<style>
		body{
				background-color: #f7f6ed;
		}

		h1{
				color: SaddleBrown;
				font-family: 'Georgia', serif;
				font-weight: bold;
				letter-spacing: 0.05em;
				text-align:center;
		}

		.title{
				font-family: 'Geogia', serif;
				font-size: 1.5em;
				font-weight: bold;
				text-align:center;
		}

		#datadesc{
				font-family: 'Geogia', serif;
				font-size: 1.5em;
				font-weight: bold;
				text-align:center;
		}

		#credits{
				color: SaddleBrown;
				font-family: 'Geogia', serif;
				font-size: 1.3em;
				font-weight: 100;
				font-style: italic;
				text-align: right;
		}

		.county {
				fill: #FFF;
				stroke: #CCC;
				stroke-width: .5px;
		}

		.regions {
				stroke: #36454f; <!-- county outline color-->
				stroke-width: 8.5px;
				stroke-linecap: round;
		}

		.map {
				border: medium solid #FFE4C4;
				margin: 10px 0 0 20px;
		}

		#map, .chart-container {
			display: inline-block;
		}

		.chart {

			margin: 10px 40px 0px 0px;
		}

		.chartTitle {
				font-family: 'Geogia', serif;
				font-size: 1.5em;
				font-weight: bold;
				fill: #8B4513;
				text-align:center;
		}

		.chartBackground {
				fill: rgba(128,128,128,.2);
		}

		.chartFrame {
				fill: none;
				stroke: #FFE4C4;
				stroke-width: 1px;
				shape-rendering: crispEdges;
		}

		.axis path,
		.axis line {
				fill: none;
				stroke: #8B4513;
				stroke-width: 1px;
				shape-rendering: crispEdges;
		}

		.axis text {
				font-family: sans-serif;
				font-size: 0.8em;
				fill: #8B4513;
		}

		.dropdown {
		position: absolute;
		top: 100px;
		left: 40px;
		z-index: 10;
		font-family: 'Geogia', serif;
		font-size: 1em;
		font-weight: bold;
		padding: 2px;
		border: 1px solid #999;
		box-shadow: 2px 2px 4px #999;
		}

		option {
		font-weight: normal;
		}


	.infolabel h1 {
	margin: 0 20px 0 0;
	padding: 0;
	display: inline-block;
	line-height: 1em;
	}

	.infolabel {
	position: absolute;
	height: 50px;
	min-width: 100px;
	color: SaddleBrown;
	background-color: #fff;
	border: solid thin #000;
	padding: 5px 10px;
	top: -75px;
	}


</style>
</head>
	<body>
		<!--put your initial page content here-->

				<div id="title"><h1>Voter Registration in Oklahoma</h1></div>
				<div id="map"></div>
				<div class="chart-container">
				</div>
					<div id = "credits"> Source: Oklahoma Election Board & Center for Spatial Analyst </div>
				<!--<div id="datadesc"> Percentage of Population Per County Registered to Vote. </div> -->


				<script
					src="https://code.jquery.com/jquery-3.4.1.min.js"
					integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
					crossorigin="anonymous"></script>
				<script src="https://d3js.org/d3-array.v1.min.js"></script>
				<script src="https://d3js.org/d3-geo.v1.min.js"></script>
				<script src="https://ajax.googleapis.com/ajax/libs/d3js/5.9.7/d3.min.js"></script>
				<script type="text/javascript" src="/VoteOK/lib/topojson/topojson.js"></script>

<script>
//wrap everything in a function


var attrArray = ["FID", "county", "countyCode", "registered10", "registered12", "registered14", "registered16", "registered18"];

//console.log(attrArray);

var expressed = 'registered10'; // attrArray[0]; //initial attribute

console.log(expressed);


//chart frame dimensions
var chartWidth = window.innerWidth * 0.425,
		chartHeight = 473,
		leftPadding = 25,
		rightPadding = 2,
		topBottomPadding = 5,
		chartInnerWidth = chartWidth - leftPadding - rightPadding,
		chartInnerHeight = chartHeight - topBottomPadding * 2,
		translate = "translate(" + leftPadding + "," + topBottomPadding + ")";

//create a scale to size bars proportionally to frame and for axis
var yScale = d3.scaleLinear()
		.range([463, 0])
		.domain([0, 110]);



//collect items to size map based on window size
var margin = {top: 10, left: 10, bottom: 10, right: 10}
	, width = window.innerWidth * 0.4
	, width = width - margin.left - margin.right
	, mapRatio = .3
	, height = width * mapRatio;


//begin script when window loads
window.onload = setMap();

//set up choropleth map
function setMap(){

	//map frame dimensions
		var width = window.innerWidth * 0.45,
				height = 600;
		//use queue to parallelize asynchronous data loading
		//create new svg container for the map
		var map = d3.select("#map")
			.attr("class", "map")
			.append("svg")
			.attr("width", width)
			.attr("height", height);

//pull in and focus my data

				var projection = d3.geoAlbers()
				.center([-.75, 33.6])
				.rotate([97.78, -2, 0])
				.parallels([29.5, 45.5])
				.scale(6000)
				.translate([width / 2, height / 2]);


		var path = d3.geoPath()
			 .projection(projection);

		/*d3.queue()
				.defer(d3.csv, "VoteOK/data/registration.csv") //load attributes from csv
				.defer(d3.json, "VoteOK/data/okcounty.topojson") //load background spatial data
				.await(callback);*/
		d3.csv('data/registrations.csv').then(function(csvData) {
			d3.json('data/okcounty.topojson').then(function(oklahoma) {
				callback(null, csvData, oklahoma);
				console.log(csvData);
			});
		});
		/*function callback(error, csvData, oklahoma){

			console.log(error);
			console.log(csvData);
			console.log(oklahoma);
};*/

//Example 1.4 line 10
function callback(error, csvData, oklahoma){

	//place graticule
	setGraticule(map, path);

		//translate europe TopoJSON
		var okcounty1 = topojson.feature(oklahoma, oklahoma.objects.okcounty1).features;

		//add Europe countries to map
		var okcounty = map.selectAll(".regions")
				.data(okcounty1)
				.enter()
				.append('path')

				.attr("class", "county")
				.attr("d", path);

				//join csv data to TopoJSON
				okcounty = joinData(okcounty1, csvData);

				console.log(csvData);


				//this is where my cholopleth problem is
				//add enumerations to the map
				setEnumerationUnits(oklahoma, map, csvData, path);
				var colorScale = makeColorScale(csvData);
				//add coordinated visualization to the map
				setChart(oklahoma, colorScale);
				createDropdown(csvData);
				setLabel({'properties': {}});


		//examine the results
	//  console.log(okcounty);
};
}; //end of setMap function

function setGraticule(map, path){
	//graticule blocks from previous function
};

function joinData(okcounty, csvData){
		//data join loops
	return okcounty;
};

function setEnumerationUnits(oklahoma, map, csvData, path){

	//region blocks from previous module

//join the cvs and excel sheet. can be done from a shapefile but practice is a goodthing
//translate europe and France TopoJSONs
var  okcounty = topojson.feature(oklahoma, oklahoma.objects.okcounty1).features;

//loop through csv to assign each set of csv attribute values to geojson region
for (var i=0; i<csvData.length; i++){
		var csvRegion = csvData[i]; //the current region
		var csvKey = csvRegion.countyCode; //the CSV primary key

		//loop through geojson regions to find correct region
		for (var a=0; a<okcounty.length; a++){

				var geojsonProps = okcounty[a].properties; //the current region geojson properties
				var geojsonKey = geojsonProps.countyCode; //the geojson primary key

				//where primary keys match, transfer csv data to geojson properties object
				if (geojsonKey == csvKey){

						//assign all attributes and values
						attrArray.forEach(function(attr){
								var val = parseFloat(csvRegion[attr]); //get csv attribute value
								geojsonProps[attr] = val; //assign attribute and value to geojson properties
						});
				};
		};
};

//create the color scale
var colorScale = makeColorScale(csvData);
var regions = map.selectAll(".regions")
		.data(okcounty)
		.enter()
		.append("path")
		.attr("class", function(d){
				return "regions county-" + d.properties.countyCode;
		})
		.attr("d", path)
		.style("fill", function(d){
				return colorScale(d.properties[expressed]);
		})
		.on("mouseover", function(d){
				highlight(d.properties);
			})
			.on("mouseout", function(d){
					dehighlight(d.properties);
				})
			.on("mousemove", moveLabel);
			// var desc = county.append("desc")
			//  .text('{"stroke": "black", "stroke-opacity": "0.8", "stroke-width": "0.5px", "stroke-linecap": "round"}');
};
//Example 1.3 line 24...add enumeration units to the map
// setEnumerationUnits(franceRegions, map, path, colorScale);

//...EXAMPLE 1.3 LINES 29-41

//function to create color scale generator
function makeColorScale(data){
var colorClasses = [
"#867f70", //colors chosen with help from photochrome.io - highest
"#a98d6e",
"#b6a088",
"#c2b5a4",
"#cbcac5"
];

//create color scale generator
var colorScale = d3.scaleQuantile()
.range(colorClasses);

//build array of all values of the expressed attribute
var domainArray = [];
for (var i=0; i<data.length; i++){
var val = parseFloat(data[i][expressed]);
domainArray.push(val);
};

//assign array of expressed values as scale domain
colorScale.domain(domainArray);

return colorScale;

console.log(colorScale)
};

//Example 1.3 line 38
function setsEnumerationUnits(okcounty, map, path, colorScale){

		//add France regions to map
		var regions = map.selectAll(".regions")
				.data(okcounty)
				.enter()
				.append("path")
				.attr("class", function(d){
						return "regions county-" + d.properties.countyCode;
				})
				.attr("d", path)
				.style("fill", function(d){
						return colorScale(d.properties[expressed]);
				});
};

//function to test for data value and return color
// function to turn 0 values to light gray, not needed in my code, but good practice
function choropleth(props, colorScale){
		//make sure attribute value is a number
		var val = parseFloat(props[expressed]);
		//if attribute value exists, assign a color; otherwise assign gray
		if (typeof val == 'number' && !isNaN(val)){
				return colorScale(val);
		} else {
				return "#CCC";
		};
};

//function to create a dropdown menu for attribute selection
function createDropdown(csvData){
//add select element
var dropdown = d3.select("#map")
.append("select")
.attr("class", "dropdown years-dropdown")
.on("change", function(){
	 changeAttribute(this.value, csvData)
});

var options = ['registered10', 'registered12', 'registered14', 'registered16', 'registered18'];
options.forEach(function(option) {
 $('.years-dropdown').append('<option value="' + option + '">' + option + '</option>');

})
};


//function to highlight enumeration units and bars
function highlight(props){
							//change stroke
	var selected = d3.selectAll(".county-" + props.countyCode)
	.style("stroke", "white")
	.style("stroke-width", "3");
					};

//function to reset the element style on mouseout
function dehighlight(props){
 var selected = d3.selectAll(".county-" + props.countyCode)
		 .style("stroke", function(){
		 return 'none'; getStyle(this, "stroke") // #36454f - county outline color I want
		 })
		.style("stroke-width", function(){
					return 0; getStyle(this, "stroke-width")
		});

		function getStyle(element, styleName){
					var styleText = d3.select(element)
				 .select("desc")
				 .text();

				 var styleObject = JSON.parse(styleText);

				 return styleObject[styleName];
						 };
				 };

				 //function to create dynamic label
function setLabel(props){
						 //label content
	 var labelAttribute = "<h1>" + props.properties[expressed] +
	 "</h1><b>" + expressed + "</b>";

	 //create info label div
	 var infolabel = d3.select("body")
	 .append("div")
	 .attr("class", "infolabel")
	 .attr("id", props.countyCode + "_label")
	 .html(labelAttribute);

		var regionName = infolabel.append("div")
		.attr("class", "labelname")
		.html(props.name);
};

//function to move info label with mouse
function moveLabel(props){
	//get width of label
	var labelWidth = d3.select(".infolabel")
			.node()
			.getBoundingClientRect()
			.width;
	var labelAttribute = "<h1>" + props.properties[expressed] +
			"</h1><b>" + expressed + "</b>";
	d3.select('.infolabel').html(labelAttribute);
	//use coordinates of mousemove event to set label coordinates
	var x1 = d3.event.clientX + 10,
			y1 = d3.event.clientY - 75,
			x2 = d3.event.clientX - labelWidth - 10,
			y2 = d3.event.clientY + 25;

	//horizontal label coordinate, testing for overflow
	var x = d3.event.clientX > window.innerWidth - labelWidth - 20 ? x2 : x1;
	//vertical label coordinate, testing for overflow
	var y = d3.event.clientY < 75 ? y2 : y1;

	d3.select(".infolabel")
			.style("left", x + "px")
			.style("top", y + "px");
};

//dropdown change listener handler
function changeAttribute(attribute, csvData){
//change the expressed attribute
expressed = attribute;

//recreate the color scale
var colorScale = makeColorScale(csvData);
var chartWidth = window.innerWidth * 0.5,
		chartHeight = 600,
		leftPadding = 45,
		rightPadding = 30,
		topBottomPadding = 5,
		chartInnerWidth = chartWidth - leftPadding - rightPadding,
		chartInnerHeight = chartHeight - topBottomPadding * 2;
		// translate = "translate(" + leftPadding + "," + topBottomPadding + ")";


//recolor enumeration units
var regions = d3.selectAll(".regions")
		.transition()
		.duration(1000)
		.style("fill", function(d){
				return choropleth(d.properties, colorScale)
		});
		// setChart(csvData, colorScale);
		//re-sort, resize, and recolor bars
		var bars = d3.selectAll(".bars")
				//re-sort bars
				.sort(function(a, b){
						return b['properties'][expressed]-a['properties'][expressed]
				})
				.transition() //add animation
				.delay(function(d, i){
						return i * 20
						})
				.duration(500)
				.attr("x", function(d, i){
						return i * (chartInnerWidth / csvData.length) + leftPadding;
				})
				//resize bars
				.attr("height", function(d, i){
						return 600 - yScale(parseFloat(d['properties'][expressed]));
				})
				.attr("y", function(d, i){
						return  yScale(parseFloat(d.properties[expressed])) + 15; //  + topBottomPadding;
				})

				 .style("fill", function(d){
						return choropleth(d['properties'], colorScale);
					});

					updateChart(bars, csvData.length, colorScale);

};

//function to position, size, and color bars in chart
function updateChart(bars, n, colorScale){
var chartWidth = window.innerWidth * 0.5,
		chartHeight = 600,
		leftPadding = 45,
		rightPadding = 30,
		topBottomPadding = 5,
		chartInnerWidth = chartWidth - leftPadding - rightPadding,
		chartInnerHeight = chartHeight - topBottomPadding * 2;
		// translate = "translate(" + leftPadding + "," + topBottomPadding + ")";

//position bars
bars.attr("x", function(d, i){
				return i * (chartInnerWidth / n) + leftPadding;
		})
		//size/resize bars
		.attr("height", function(d, i){
				return chartHeight - yScale(parseFloat(d.properties[expressed]));
		})
		.attr("y", function(d, i){
				return  yScale(parseFloat(d.properties[expressed])) + 15; // + topBottomPadding;
		})
		//color/recolor bars
		.style("fill", function(d){
				return choropleth(d.properties, colorScale);

				//at the bottom of updateChart()...add text to chart title
				var chartTitle = d3.select(".chartTitle")
				.text("Number of Variable in Each Region");
		});


/*//add initial option
var titleOption = dropdown.append("option")
.attr("class", "titleOption")
.attr("disabled", "true")
.text("Select Attribute");

//add attribute name options
var attrOptions = dropdown.selectAll("attrOptions")
.data(attrArray)
.enter()
.append("option")
.attr("value", function(d){ return d })
.text(function(d){ return d }); */
};

//function to create coordinated bar chart
function setChart(csvData, colorScale){
		//chart frame dimensions
		var chartWidth = window.innerWidth * 0.5,
				chartHeight = 600,
				leftPadding = 45,
				rightPadding = 30,
				topBottomPadding = 5,
				chartInnerWidth = chartWidth - leftPadding - rightPadding,
				chartInnerHeight = chartHeight - topBottomPadding * 2,
				translate = "translate(" + leftPadding + "," + topBottomPadding + ")";

		//create a second svg element to hold the bar chart
		var chart = d3.select(".chart-container")
				.append("svg")
				.attr("width", chartWidth)
				.attr("height", chartHeight)
				.attr("class", "chart");

				//create a rectangle for chart background fill
		var chartBackground = chart.append("rect")
					 .attr("class", "chartBackground")
					 .attr("width", chartInnerWidth)
					 .attr("height", chartInnerHeight)
					 .attr("transform", translate);
					csvData = csvData.objects.okcounty1.geometries;



							 //create a scale to size bars proportionally to frame
								var yScale = d3.scaleLinear()
										.range([0, chartHeight])
										.domain([105, 0]);

								//Example 2.4 line 8...set bars for each province
									var bars = chart.selectAll(".bars")
										.data(csvData)
										.enter()
										.append("rect")
										.sort(function(a,b){
										 return b['properties'][expressed]-a['properties'][expressed]
										})
										.attr("class", function(d){
											return "bars county-" + d.properties.countyCode;
										})
										.attr("width", chartInnerWidth / csvData.length - 1)
										.on("mouseover", highlight)
										.on("mouseout", dehighlight)
										.on("mousemove", moveLabel)

										// var desc = bars.append("desc")
											//.text('{"stroke": "none", "stroke-width": "0px"}')

										.attr("x", function(d, i){
												return i * (chartInnerWidth / csvData.length) + leftPadding;
										})
										.attr("height", function(d, i){
												return 600 - yScale(parseFloat(d['properties'][expressed]));
										})
										.attr("y", function(d, i){
												return yScale(parseFloat(d['properties'][expressed])) + topBottomPadding;
										})

										 .style("fill", function(d){
											 return choropleth(d['properties'], colorScale);

											 //CHARTTITLE, YAXIS, AXIS, AND CHARTFRAME BLOCKS

											 //set bar positions, heights, and colors
											 updateChart(bars, csvData.length, colorScale);
					 });



//annotate bars with attribute value text
 var numbers = chart.selectAll(".numbers")
						 .data(csvData)
						 .enter()
						 .append("text")
						 .sort(function(a, b){
								 return a[expressed]-b[expressed]
						 })
						 .attr("class", function(d){
								 return "numbers " + d.countyCode;
						 })
						 .attr("text-anchor", "middle")
						 .attr("x", function(d, i){
								 var fraction = chartWidth / csvData.length;
								 return i * fraction + (fraction - 1) / 2;
						 })
						 .attr("y", function(d){
								 return chartHeight - yScale(parseFloat(d.properties[expressed])) + 15;
						 })
						 .text(function(d){
								 return d[expressed];
						 });

//below Example 2.8...create a text element for the chart title
var chartTitle = chart.append("text")
			 .attr("x", 60)
			 .attr("y", 40)
			 .attr("class", "chartTitle")
			 .text(" Number of Registered Voters in Each County");



 //create vertical axis generator
var yAxis = d3.axisLeft()
							 .scale(yScale);
							 //.orient("left");

					 //place axis
var axis = chart.append("g")
							 .attr("class", "axis")
							 .attr("transform", translate)
							 .call(yAxis);

					 //create frame for chart border
var chartFrame = chart.append("rect")
							 .attr("class", "chartFrame")
							 .attr("width", chartInnerWidth)
							 .attr("height", chartInnerHeight)
							 .attr("transform", translate);




};
// })(); // end of my over all function
 </script>
 </body>
</html>
